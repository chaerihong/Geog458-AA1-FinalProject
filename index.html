<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="description" content="Hospital Accessibility" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Hospital Accessibility</title>
  <!-- <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,400;0,500;1,400;1,500&display=swap" /> -->
  <!-- <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css"> -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"> -->
  <link rel="stylesheet" href="css/main.css">
  <script src="https://unpkg.com/scrollama"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>
</head>

<body>
  <!-- loading a video cover page -->
  <section id="cover">
    <!-- loading a video as the background -->
    <video class="fullscreen canvas-center" playsinline="" autoplay="" muted="" loop="">
      <source src="assets/intro.mp4" type="video/mp4">
    </video>
    <div id="intro">
      <h1>Hospital Accessibility</h1>
      <h5>"Having a local hospital or access to care is critical in an emergency situation where minutes can make a big difference... More than 100 (or 4% of) rural hospitals closed from 2013 through 2020. As a result, residents had to travel about 20 miles farther for common services like inpatient care..."  https://www.gao.gov/blog/why-health-care-harder-access-rural-america</p>

      <div class="footnote">
        <a class="white-link" target="_blank" href="https://www.pexels.com/video/a-clean-office-building-3197808/">Video by Andrey Kirievskiy</a>
      </div>
    </div>
  </section>
  <!-- a geonarrative will have two major components, a storyboard and a script panel of a series of scenes/actions -->
  <section id="geonarrative">
    <!-- a storymap can present differnt types of objects, like map, chart, diagram, etc. -->
    <div id="storyboard">
      <!-- create the place holder element for map -->
      <div id="map"></div>
    </div>

    <article class="scene" data-scene="0">
      <h2>Hospitals in the US</h2>
    </article>
    <article class="scene" data-scene="1">
      <h2>Hospitals and County Population in WA </h2>
    </article>
    <article class="scene" data-scene="2">
      <h2>Total Beds in Hospitals in WA</h2>
    </article>
    <article class="scene" data-scene="3">
      <h2>Hospital Accessibility for Minority Populations by Census Tract in Seattle, WA</h2>
    </article>
    <article class="scene fullscreen" data-scene="4">
      <h2>Conclusion</h2>
    </article>

  </section>

  <section id="footer">
    <h2>By: Yezhen Chen, Abi Chinn, Chaeri Hong, Elijah Price, & Wyatt Stanley</h2>
    <h2>GEOG 458 Group AA1</h2>
  </section>


  <script>
    // 1. Declare the maps, script panels, and different thematic layers.
    let map, scriptPanel = scrollama(), ushospitalLayer, emsLayer;

    // 2. Intialize the layout.
   
    history.scrollRestoration = "manual"; // make sure the geo-narrative will be scrolled to the cover page even after a page refresh.
    window.scrollTo(0, 0); // scroll the geo-narrative to the coverpage
    adjustStoryboardlSize(); // force a browser window resize.
    window.addEventListener("resize", adjustStoryboardlSize); // // ask the browser window listen to the resize event, thereby force a viewport resize whenever adjusting the window size.

    // 3. Define Generic window resize listener event
    function adjustStoryboardlSize() {

      const scenes = document.getElementsByClassName("scene");
      const storyboard = document.getElementById("storyboard");

      // 3.1 determine the height of each scene element
      let sceneH = Math.floor(window.innerHeight * 0.75);
      for (const scene of scenes) {
        scene.style.height = sceneH + "px";
      }
      
      // 3.2 determin the height of the storyboard.
      let storyboardHeight = window.innerHeight;
      let storyboardMarginTop = (window.innerHeight - storyboardHeight) / 2;

      storyboard.style.height = storyboardHeight + "px";
      storyboard.style.top = storyboardMarginTop + "px"

      // 3.3 tell scrollama/script panel to update new element dimensions
      scriptPanel.resize();
    }

    // 4. Initialize the mapbox
    mapboxgl.accessToken =
      'pk.eyJ1IjoiamFrb2J6aGFvIiwiYSI6ImNpcms2YWsyMzAwMmtmbG5icTFxZ3ZkdncifQ.P9MBej1xacybKcDN_jehvw'; // Assign the access token
   
    map = new mapboxgl.Map({
      container: 'map', // container ID
      style: 'mapbox://styles/mapbox/light-v10',
      zoom: 4, // starting zoom
      minZoom: 3,
      maxZoom: 15,
      center: [-109.4151140079552, 41.25017612415869], // starting center
      scrollZoom: false,
      boxZoom: false,
      doubleClickZoom: false
    });  // Declare the map object

    // An alternative way to disable map zoom when using scroll
    // map.scrollZoom.disable();


    // 5. define the asynchronous function to load geojson data and then performs the dependent actions.
    async function geojsonFetch() {

      // 6 wait till the data of washington counties and ems are fully loaded.
      let response, ushospital, ems, minority;
      response = await fetch("assets/ushospital.geojson");
      ushospital = await response.json();
      response = await fetch("assets/EMS_Stations.geojson");
      ems = await response.json();
      response = await fetch("assets/minority.geojson");
      minority = await response.json();


      // 7. Trigger operations inside of the the ()=> {} funciton while loading the map.
      map.on('load', () => {

        // ADDING CLICKABLE POINTS
        map.on('click', function(e) {
          // Get features at the clicked point
          var features = map.queryRenderedFeatures(e.point, { layers: ['ushospital-points'] });

          if (!features.length) {
              return;
          }

          var feature = features[0];

          // You can now access properties of the clicked feature and display them
          var popup = new mapboxgl.Popup()
              .setLngLat(feature.geometry.coordinates)
              .setHTML('<h3>' + feature.properties.NAME + '</h3><p>' + feature.properties.CITY + '</p>')
              .addTo(map);
        });

        // 8. add map source and declare layers.
        map.addSource('ems-src', {
          type: 'geojson',
          data: ems
        });

        map.addSource('ushospital-src', {
          type: 'geojson',
          data: ushospital
        });

        ushospitalLayer = {
          'id': 'ushospital-points',
          'type': 'circle',
          'source': 'ushospital-src',
          'minzoom': 5,
          'paint': {
            'circle-color': 'red',
            'circle-radius': 4,
            'circle-opacity': 0.8,
          }
        };

        emsLayer = {
          'id': 'ems-points',
          'type': 'circle',
          'source': 'ems-src',
          'minzoom': 5,
          'paint': {
            'circle-color': 'blue',
            'circle-radius': 2,
            'circle-opacity': 0.7,
          }
        };

        map.addSource('race-data', {
            type: 'geojson',
            data: minority
        });
        
        map.addLayer({
            'id': 'race-layer',
            'type': 'fill',
            'source': 'race-data',
            'paint': {
                'fill-color': [
                    'step',
                    ['get', 'MinorityP'],
                    '#c0cffa',
                    500,
                    '#9daddf',
                    1000,
                    '#7d8ec4',
                    1500,
                    '#6171a9',
                    2000,
                    '#756bb1',
                    2500,
                    '#334173',
                    3000,
                    '#640A8D',
                    3500,
                    '#410C59',
                    4000,
                    '#14001E'
                ],
                'fill-outline-color': '#bcbcbc',
            }
        });

        // 9. Initialize the script panel
        scriptPanel
          .setup({
            step: ".scene", // all the scenes.
            offset: 0.33, // the location of the enter and exit trigger
            debug: false // toggler on or off the debug mode.
          })
          .onStepEnter(handleSceneEnter)
          .onStepExit(handleSceneExit);
        
        // 10. This function performs when a scene enters the storyboard
        function handleSceneEnter(response) {

          var index = response.index; // capture the id of the current scene. 

          if (index === 0 || index === 3) { // When entering scene 0 or 3
            map.flyTo({
                center: [-124.5, 40],
                zoom: 5,
                pitch: 30,
                speed: 0.5
            }); // Fly to a new location
            
            if (typeof (map.getSource('ushospital-src')) == 'undefined') { // If the map source 'ushospital-src' does not exist
                map.addSource('ushospital-src', {
                    type: 'geojson',
                    data: ushospital
                }); // Add the map source of 'ushospital-src'
            } else {
                map.getSource('ushospital-src').setData(ushospital); // If the map source exists, reload the data for 'ushospital-src'
            }

            if (!map.getLayer("ushospital-points")) { // If the map layer 'ushospital-points' does not exist
                map.addLayer(ushospitalLayer); // Add the hospital layer
            }

            if (index === 3) { // When entering scene 3
            map.flyTo({
                center: [-122.3659068281188, 47.591669543756304],
                zoom: 11,
                pitch: 0,
                speed: 2
            }); // Zoom in for scene 3
            
            if (map.getLayer("race-layer")) {
                map.setLayoutProperty("race-layer", "visibility", "visible"); // Show the race layer
            }
          } if (index !== 3) {
              map.setLayoutProperty("race-layer", "visibility", "none");
            }
          document.getElementById("cover").style.visibility = "hidden"; 
        
        }
          
          else if (index === 1) { // When enter the second scene.
            map.flyTo({
              center: [-122.32924428512132, 47.646212989022125],
              zoom: 8,
              pitch: 60,
              speed: 0.5

            });

            if (typeof (map.getSource('ems-src')) == 'undefined') {
              map.addSource('ems-src', {
                type: 'geojson',
                data: ems
              });
            } else {
              map.getSource('ems-src').setData(ems);

            }

            if (!map.getLayer("ems-points")) {
              map.addLayer(emsLayer);
            }
           


            if (typeof (map.getSource('ushospital-src')) == 'undefined') {
                map.addSource('ushospital-src', {
                  type: 'geojson',
                  data: ushospital
                });
              } else {
                map.getSource('ushospital-src').setData(ushospital);
              }

              if (!map.getLayer("ushospital-points")) {
                map.addLayer(ushospitalLayer);
              }
           
          
          } else if (index === 2) {
            //Relocate to Seattle
            map.flyTo({
              center: [-122.32924428512132, 47.645212989022125],
              zoom: 7,
              pitch: 0,
              speed: 0.5
            });

          } 
          
        }

        // 11. This function performs when a scene exists the storyboard
        function handleSceneExit(response) {
          var index = response.index;

          if (index === 0 || index === 3) {
            if (map.getLayer("ushospital-points")) {
              map.removeLayer('ushospital-points');
            }
            if (response.direction == 'down') { 
              document.getElementById("cover").style.visibility = "hidden"; // when you scroll down, the cover page will be hided.
            } else {
              document.getElementById("cover").style.visibility = "visible"; // when you scroll up, the cover page will be shown.
            }
          }
          
          else if (index === 1) {
            if (map.getLayer("ems-points")) {
              map.removeLayer('ems-points');
            }
          }

          // if (index === 3) { 
          //   if (map.getLayer("race-layer")) {
          //     map.removeLayer("race-layer");
          //   }
          // }

        }


      });

    };

    // 5 call the data loading function.
    geojsonFetch();
  </script>
</body>

</html>